---
title: Rebuilding my portfolio...
date: 2017-03-27
tags:
  - Metalsmith
  - Portfolio
  - Personal Website
  - Writings
  - Projects
  - JavaScript
  - Gulp 4
---
Welcome to my new website! It's been long overdue, but I've finally gotten around to rebuilding my portfolio and personal website. Here's a rundown of what's new and how it all works.

# What's new?
Lots! Before this site, the only thing you'd have seen visiting davidtw.co was a pretty basic 'coming soon...' page, and before that a very basic AngularJS application.

There are three main sections to the site (if you're looking up at the navigation and thinking you might be missing something - you're not, the "Labs" section is temporarily disabled while I work together some content): Projects, Writings and Labs.

## Projects
This is exactly what it says on the tin - an overview of the projects I've completed over the past few years. Newer projects have a nice cover image I've thrown together in [Affinity Designer](https://affinity.serif.com/en-gb/designer/), a short paragraph describing the project and then maybe a link or two to check it out or read the source.


## Writings
You're already here! This section will contain my ramblings about a variety of topics, from whatever development project I'm working on to whatever the hobby of the month is.

I don't expect that I'll write here too much, I'll try my best.

## Labs
This might be the only section that where it isn't abundantly obvious what it is. "Labs" will function like a personal wiki, it'll contain some structured content on a variety of topics - everything from personal notes and references on Vim to some guides for tmux, who knows..

# How does it work?
One of the main goals when building this website was to keep it simple so that it'd be really easy to build upon and expand. Aspiring to that goal, I decided to go with a simple static site, and as a bonus, I'd be able to host the website inexpensively; free myself of the burden of keeping a CMS up-to-date and have a easy and quick to set up development environment.

Specifically, I went with [Metalsmith](http://www.metalsmith.io) - I wanted something that was in a language I was familiar and comfortable with, had a relatively active community and was easily extensible.

After some research, I decided to use Metalsmith in the context of a Gulp pipeline. For this project, I also chose to use the upcoming Gulp 4 with ES2015, you can see an excerpt of that below. If you're interested in [seeing the whole source, here's a link to the repository](https://gitlab.com/davidtwco/personal-website/blob/master/gulpfile.babel.js#L66).

```javascript
export function metalsmith(callback) {
  let layoutDir = pkg.settings.src.layouts;
  let loader = new nunjucks.FileSystemLoader(layoutDir);
  let environment = new nunjucks.Environment(loader);
  // We can add our own globals and filters to Nunjucks here.

  const m = Metalsmith(__dirname)
    .metadata(pkg.settings.meta)
    .source(pkg.settings.src.content)
    .destination(pkg.settings.dist)
    .clean(true)
    // ...a bunch more plugins...
    .use(markdown({
      gfm: true,
      tables: true
    }))
    // ...a bunch more plugins...
    .use(layouts({
      engine: 'nunjucks',
      directory: pkg.settings.src.layouts,
      nunjucksEnv: environment
    }))
    // ...maybe one more plugin...
    .use(assets({
      source: pkg.settings.assets,
      dest: '.'
    }))
    .build((err) => {
      if (err) throw err;
      callback();
    });
}
```

In Gulp 4, tasks are specified using the CommonJS export notation and since we're using the ES2015 syntax, we can do that by adding the `export` keyword before the function definition.

I tend to specify any settings for the project in the package.json file, importing it in as below.

```javascript
import fs from 'fs';
const pkg = JSON.parse(fs.readFileSync('./package.json'));
```

After this, I can access my source and dist directories easily as demonstrated in the previous larger snippet.

Metalsmith hasn't got a lot of documentation and I had to rely on a handful of blog posts (like this one) that details how another developer used it. Here are a handful of little things that tripped me up..

1. **Order is important**: The order of your plugins are important, plugins that operate on HTML files will need to come after the `metalsmith-markdown` plugin.

2. **Watch your frontmatter**: I found that the `metalsmith-markdown` plugin likes to fail silently, if you find that you're missing the metadata attributes from your files (perhaps you accidently indented using tabs in the YAML rather than spaces) then you'll find some missing attributes and no message explaining why.

3. **Add a short debug snippet**: Metalsmith's plugins are incredibly simple, they are just a function! Remember the following snippet and insert it to help track down where unexpected behaviour occurs.

```javascript
  // ...previous plugins...
  .use((files, metalsmith, done) => {
    console.log(files);
  })
  // ...upcoming plugins...
```

Metalsmith has two plugins that you can use for templating - [metalsmith-layouts](https://github.com/superwolff/metalsmith-layouts) and [metalsmith-in-place](https://github.com/superwolff/metalsmith-in-place).

`metalsmith-layouts` works by checking the `layout` attribute in your Markdown files, and then rendering with that template. This works similarly to Django and Flask's templating if you are familiar with that - but instead you specify the context and layout in the frontmatter (the body is added as a `contents` property).

`metalsmith-in-place` allows for in-place templating. I opted to use the `metalsmith-layouts` plugin (though I believe you can use them both together if required) and so I'm not going to go into how to use `metalsmith-in-place`.

Both these plugins are very flexible in that they let you use any templating language that works with [consolidate.js](https://github.com/tj/consolidate.js) - and that's quite a few.

I went with [Nunjucks](https://mozilla.github.io/nunjucks/), by Mozilla - it's built to look like Jinja2, which might sound familiar if you've used Flask before. Nunjucks supports template inheritance and is very easy to extend with custom filters and globals.


```javascript
export function metalsmith(callback) {
  let layoutDir = pkg.settings.src.layouts;
  let loader = new nunjucks.FileSystemLoader(layoutDir);
  let environment = new nunjucks.Environment(loader);
  // nunjucksDate is a handy npm package that lets allows
  // formatting of dates in the templates using
  // moment.js
  environment.addFilter('date', nunjucksDate);
  // evaluates a global function on an object.
  // {{ item.ancestry.self | evaluate(isBaseLabCollection) }}
  environment.addFilter('evaluate', function(obj, fn) {
    return fn(obj);
  });
  // filters a list based on a fn that returns true/false.
  environment.addFilter('filter', function(objs, fn, negate = false) {
    if (objs.constructor !== Array) return objs;

    if (negate)
      return objs.filter((obj) => !fn(obj));
    return objs.filter(fn);
  });
  // Checks if the path is at the root of a directory.
  environment.addGlobal('isBaseLabCollection', function(obj) {
    return obj.paths.dir.indexOf('/') === -1;
  });
  // Returns the path after the first directory.
  environment.addGlobal('getLabCollection', function (obj) {
    let index = obj.paths.dir.indexOf('/');
    if (index === -1) return obj.paths.dir;

    return obj.paths.dir.substring(index + 1);
  });

  const m = Metalsmith(__dirname)
  // ...the first few Metalsmith plugins...
    .use(layouts({
      engine: 'nunjucks',
      directory: pkg.settings.src.layouts,
      nunjucksEnv: environment
    }))
  // ..the final few Metalsmith plugins...
}
```

If Nunjucks works out of the box for you then you won't even need the environment setup! In that case you can just leave the `nunjucksEnv` property out of the `layouts()` call.

I think that about covers some of the not-so-obvious things about how I built this new website using Metalsmith, if you have any more questions or queries about how this website was built, let me know and maybe I'll write another post on it.

## How was it deployed?
I chose to deploy the website using [Netlify](https://netlify.com)'s Pro tier. Luckily Netlify offer that tier for free to open source/non-commercial projects. If you'd prefer to keep your source closed, Netlify's regular free tier covers custom domains and HTTPS - all you need to do is link it to your GitHub, GitLab or Bitbucket and specify the build command.

You can also use [GitHub Pages](https://pages.github.com/) or [GitLab Pages](https://pages.gitlab.io/) - both of which are excellent.

---

Thanks for reading and checking out my new site!
